@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentinvitationsfrontend.config.ExternalUrls
@import uk.gov.hmrc.agentinvitationsfrontend.models.TrackedInvitation

@import org.joda.time.format.ISODateTimeFormat
@(invitations: Seq[TrackedInvitation], trackRequestsShowLastDays: Int)(implicit request: Request[_], messages: Messages, configuration: Configuration, externalUrls: ExternalUrls)

@uk.gov.hmrc.agentinvitationsfrontend.views.html.main_template(title = Messages("generic.title", Messages("recent-invitations.header"), Messages("title.suffix.agents")), bodyClasses = Some("full-width"), isAgent = true) {

   @back_link(s"${externalUrls.agentServicesAccountUrl}")

    <div class="grid-row">
        <div class="column-two-thirds">

            <h1 class="heading-xlarge" style="margin-bottom: 30px;">@Messages(s"recent-invitations.header")</h1>

            <p>@Messages(s"recent-invitations.description", trackRequestsShowLastDays)</p>

        </div>
    </div>

    <div class="clearer"></div>

    <table class="monitor-authorisations">
        <col class="sortable-header" style="width: 30%">
        <col class="sortable-header">
        <col class="sortable-header" style="width: 20%">
        <thead>
            <tr>
                <th scope="col">@Messages("recent-invitations.table-row-header.clientName")</th>
                <th scope="col">@Messages("recent-invitations.table-row-header.service")</th>
                <th scope="col">@Messages("recent-invitations.table-row-header.status")</th>
            </tr>
        </thead>
        <tbody>
        @if(invitations.nonEmpty) {
            @invitations.map { invitation =>
                <tr>
                    <td id="taxpayerName">
                        <span>@invitation.clientName.getOrElse("")</span>
                        <span class="supplementary-information">@clientIdentifierInfo(invitation)</span>
                    </td>
                    <td id="serviceInfo">
                        <span>@Messages(s"recent-invitations.invitation.service.${invitation.service}")</span>
                    </td>
                    <td id="status">
                        @invitation.effectiveStatus
                        <span class="supplementary-information">@dateInfo(invitation)</span>
                    </td>
                </tr>
            }
        } else {
            <p>@Messages(s"recent-invitations.empty")</p>
            <p>
                <a href="/invitations/agents/select-services">@Messages(s"recent-invitations.empty.continue")</a>.
            </p>
        }
        </tbody>
    </table>

}

@dateInfo(invitation: TrackedInvitation)(implicit messages: Messages) = {
    @if(invitation.effectiveStatus=="Pending") {
        <span>@Messages("recent-invitations.invitation.expires")</span> @{invitation.expiryDate.toString("dd MMMM yyyy", messages.lang.locale)}
    } else {
        @{invitation.lastUpdated.toString("dd MMMM yyyy", messages.lang.locale)}
    }

}

@clientIdentifierInfo(invitation: TrackedInvitation)(implicit messages: Messages) = {
    @{invitation.service match {
        case "HMRC-MTD-IT" => ninoIdentifier(invitation.clientId)
        case "HMRC-MTD-VAT" => vrnIdentifier(invitation.clientId)
        case "PERSONAL-INCOME-RECORD" => ninoIdentifier(invitation.clientId)
        case _ => ""
    }}
}

@ninoIdentifier(nino: String)(implicit messages: Messages) = {
    <span>@Messages("recent-invitations.invitation.identifier.nino")</span> @{nino.sliding(2,2).mkString(" ")}
}

@vrnIdentifier(vrn: String)(implicit messages: Messages) = {
    <span>@Messages("recent-invitations.invitation.identifier.vrn")</span> @vrn
}

@back_link(url: String)(implicit messages: Messages, config: Configuration) = {
    <a id="identifiersBackLink" href="@url" class="link-back">@Messages("button.back")</a>
}
