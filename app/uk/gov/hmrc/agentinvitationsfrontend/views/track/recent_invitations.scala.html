@*
 * Copyright 2018 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentinvitationsfrontend.config.ExternalUrls
@import uk.gov.hmrc.agentinvitationsfrontend.models.TrackedInvitation
@import org.joda.time.{LocalDate,DateTime}

@import uk.gov.hmrc.agentinvitationsfrontend.models.TrackInformationSorted
@(invitationsAndRelationships: Seq[TrackInformationSorted], trackRequestsShowLastDays: Int)(implicit request: Request[_], messages: Messages, configuration: Configuration, externalUrls: ExternalUrls, now: LocalDate))

@uk.gov.hmrc.agentinvitationsfrontend.views.html.main_template(title = Messages("generic.title", Messages("recent-invitations.header"), Messages("title.suffix.agents")), bodyClasses = Some("full-width"), isAgent = true) {

   @back_link(s"${externalUrls.agentServicesAccountUrl}/agent-services-account")

   <div class="text">
       <h1 class="heading-xlarge margin-bottom-30">@Messages(s"recent-invitations.header")</h1>
    </div>
    @if(invitationsAndRelationships.nonEmpty) {

        <table>
            <caption class="caption-normal text margin-bottom-20">
                @Messages(s"recent-invitations.description", trackRequestsShowLastDays)
            </caption>
            <col style="width: 30%">
            <col>
            <col style="width: 20%">
            <thead>
                <tr>
                    <th scope="col">@Messages("recent-invitations.table-row-header.clientName")</th>
                    <th scope="col">@Messages("recent-invitations.table-row-header.service")</th>
                    <th scope="col">@Messages("recent-invitations.table-row-header.status")</th>
                </tr>
            </thead>
            <tbody>
                @invitationsAndRelationships.map { invitationOrRelationship =>
                    <tr>
                        <td id="taxpayerName">
                            <span>@invitationOrRelationship.clientName.getOrElse("")</span>
                        </td>
                        <td id="serviceInfo">
                            <span>@Messages(s"recent-invitations.invitation.service.${invitationOrRelationship.service}")</span>
                        </td>
                        <td id="status">
                            @Messages(s"recent-invitations.invitation.status.${invitationOrRelationship.effectiveStatus.toLowerCase}")
                            <span class="supplementary-information">@dateInfo(invitationOrRelationship)</span>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    } else {
        <p class="text">@Messages(s"recent-invitations.description", trackRequestsShowLastDays)</p>
        <p>@Messages(s"recent-invitations.empty")</p>
        <p>
            <a href="/invitations/agents/select-service">@Messages(s"recent-invitations.empty.continue")</a>
        </p>
    }
}

@dateInfo(invitation: TrackInformationSorted)(implicit messages: Messages) = {
    @if(invitation.effectiveStatus=="Pending") {
        <span>@Messages("recent-invitations.invitation.expires")</span> @displayDate(invitation.expiryDate.getOrElse(LocalDate.now()))
    } else {
        @if(invitation.effectiveStatus=="Expired") {
            @displayDate(invitation.expiryDate.getOrElse(LocalDate.now()))
        } else {
            @displayDate(invitation.date.getOrElse(LocalDate.now()))
        }
    }
}

@clientIdentifierInfo(invitation: TrackedInvitation)(implicit messages: Messages) = {
    @{invitation.clientIdType match {
        case "ni" => ninoIdentifier(invitation.clientId)
        case "vrn" => vrnIdentifier(invitation.clientId)
        case "MTDITID" => mtditidIdentifier(invitation.clientId)
        case _ => ""
    }}
}

@displayDate(date: LocalDate) = {
    @date.toString("dd MMMM yyyy", messages.lang.locale)
}

@displayDateMaybe(maybeDate: Option[LocalDate]) = {
    @{maybeDate match {
        case Some(date) => date.toString("dd MMMM yyyy", messages.lang.locale)
        case None => ""
    }}
}

@ninoIdentifier(nino: String)(implicit messages: Messages) = {
    <span>@Messages("recent-invitations.invitation.identifier.nino")</span> <span>@{nino.sliding(2,2).mkString(" ")}</span>
}

@vrnIdentifier(vrn: String)(implicit messages: Messages) = {
    <span>@Messages("recent-invitations.invitation.identifier.vrn")</span> <span>@vrn</span>
}

@mtditidIdentifier(mtditid: String)(implicit messages: Messages) = {
    <span>@Messages("recent-invitations.invitation.identifier.mtditid")</span> <span>@mtditid</span>
}

@back_link(url: String)(implicit messages: Messages, config: Configuration) = {
    <a id="identifiersBackLink" href="@url" class="link-back">@Messages("button.back")</a>
}
