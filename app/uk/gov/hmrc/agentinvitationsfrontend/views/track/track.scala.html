@*
 * Copyright 2019 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentinvitationsfrontend.config.ExternalUrls
@import org.joda.time.LocalDate

@import uk.gov.hmrc.agentinvitationsfrontend.models.TrackInformationSorted
@import uk.gov.hmrc.agentinvitationsfrontend.views.html.track.{new_request_form, pending_form, cancel_authorisation_form}
@import uk.gov.hmrc.agentinvitationsfrontend.views.html.agents.back_link
@import uk.gov.hmrc.agentinvitationsfrontend.controllers.routes

@import uk.gov.hmrc.agentinvitationsfrontend.views.track.TrackPageConfig
@(config: TrackPageConfig)(implicit request: Request[_], messages: Messages, configuration: Configuration, externalUrls: ExternalUrls, now: LocalDate)

@uk.gov.hmrc.agentinvitationsfrontend.views.html.main_template(title = Messages("generic.title", Messages("recent-invitations.header"), Messages("title.suffix.agents")), bodyClasses = Some("full-width"), isAgent = true) {

    @back_link(s"${externalUrls.agentServicesAccountUrl}/agent-services-account")

    <div class="text">
        <h1 class="heading-xlarge margin-bottom-40">@Messages(s"recent-invitations.header")</h1>
    </div>


    <p class="margin-bottom-40">
    @Messages(s"recent-invitations.description", config.trackRequestsShowLastDays)
    </p>

    @if(config.hasInvitationsOrRelationships) {
        <div class="table text-small">
            <div class="table-row table-head">
                <div class="table-cell column-22">@Messages("recent-invitations.table-row-header.clientName")</div>
                <div class="table-cell column-30">@Messages("recent-invitations.table-row-header.service")</div>
                <div class="table-cell column-28">@Messages("recent-invitations.table-row-header.status")</div>
                <div class="table-cell column-20">@Messages("recent-invitations.table-row-header.actions")</div>
            </div>
            @config.invitationsAndRelationships.zipWithIndex.map { case (invitationOrRelationship, index) =>
            <div id="row-@index" class="table-row">
                <div class="table-cell taxpayerName">
                    <h2 class="sr-only">Row @index</h2>
                    <h3 class="context">@Messages("recent-invitations.table-row-header.clientName")</h3>
                    <span>@invitationOrRelationship.clientName.getOrElse("")</span>
                </div>
                <div class="table-cell serviceInfo">
                    <h3 class="context">@Messages("recent-invitations.table-row-header.service")</h3>
                    <span>@Messages(s"recent-invitations.invitation.service.${invitationOrRelationship.service}")</span>
                </div>
                <div class="table-cell status">
                    <h3 class="context">@Messages("recent-invitations.table-row-header.status")</h3>
                    @Messages(s"recent-invitations.invitation.status.${invitationOrRelationship.status.toLowerCase}")
                    <span class="supplementary-information">@dateInfo(invitationOrRelationship)</span>
                </div>
                <div class="table-cell action @invitationOrRelationship.status.toLowerCase()">
                    <h3 class="context">@Messages("recent-invitations.table-row-header.actions")</h3>
                    @{
                        invitationOrRelationship.status match {
                            case "Pending" => pending_form(invitationOrRelationship, index)
                            case "Accepted" => if(config.cancelAuthActionFlag) {
                                cancel_authorisation_form(invitationOrRelationship, index)
                            }
                            case _ => new_request_form(invitationOrRelationship, index)
                        }
                    }
                </div>
            </div>
            }
        </div>
    } else {
        <p class="text">@Messages(s"recent-invitations.description", config.trackRequestsShowLastDays)</p>
        <p>@Messages(s"recent-invitations.empty")</p>
        <p>
            <a href="@routes.AgentInvitationJourneyController.showSelectService()">@Messages(s"recent-invitations.empty.continue")</a>
        </p>
    }
}

@dateInfo(invitation: TrackInformationSorted)(implicit messages: Messages) = {
@if(invitation.status == "Pending") {
    <span>@Messages("recent-invitations.invitation.expires")</span>
    @displayDate(invitation.expiryDate)
} else {
    @if(invitation.status == "Expired") {
        @displayDate(invitation.expiryDate)
    } else {
        @displayDate(invitation.date)
    }
}
}

@displayDate(date: Option[LocalDate]) = {
@{
    date match {
        case Some(d) => d.toString("dd MMMM yyyy", messages.lang.locale)
        case None => ""
    }
}
}
