@*
 * Copyright 2020 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import org.joda.time.LocalDate
@import play.api.Configuration
@import uk.gov.hmrc.agentinvitationsfrontend.config.ExternalUrls
@import uk.gov.hmrc.agentinvitationsfrontend.controllers.routes
@import uk.gov.hmrc.agentinvitationsfrontend.models.TrackInformationSorted
@import uk.gov.hmrc.agentinvitationsfrontend.views.html.agents.back_link
@import uk.gov.hmrc.agentinvitationsfrontend.views.html.main_template
@import uk.gov.hmrc.agentinvitationsfrontend.views.html.track._
@import uk.gov.hmrc.agentinvitationsfrontend.views.track.TrackPageConfig

@this(
    mainTemplate: main_template,
    pendingForm: pending_form,
    cancelAuthForm: cancel_authorisation_form,
    newRequestForm: new_request_form
)

@(config: TrackPageConfig)(implicit request: Request[_], messages: Messages, configuration: Configuration, externalUrls: ExternalUrls, now: LocalDate)

@mainTemplate(title = Messages("generic.title", Messages("recent-invitations.header"), Messages("title.suffix.agents")), bodyClasses = Some("full-width"), isAgent = true) {

    @back_link(externalUrls.agentServicesAccountUrl)

    <div class="text">
        <h1 class="heading-xlarge margin-bottom-40">@Messages(s"recent-invitations.header")</h1>
    </div>


    <p class="margin-bottom-40">
    @Messages(s"recent-invitations.description", config.trackRequestsShowLastDays)
    </p>

    @if(config.hasInvitationsOrRelationships) {
        <div class="table text-small">
            <div style="font-size: 16.5px; margin-bottom: 0.5em;">@Messages("recent-invitations.pagination.showing")
                <strong class="bold">@config.firstResult</strong>
                @Messages("recent-invitations.pagination.to") <strong class="bold">@config.lastResult</strong>
                @Messages("recent-invitations.pagination.of") <strong class="bold">@config.totalResults</strong>
            </div>
            <div class="table-row table-head">
                <div class="table-cell column-22">@Messages("recent-invitations.table-row-header.clientName")</div>
                <div class="table-cell column-30">@Messages("recent-invitations.table-row-header.service")</div>
                <div class="table-cell column-28">@Messages("recent-invitations.table-row-header.status")</div>
                <div class="table-cell column-20">@Messages("recent-invitations.table-row-header.actions")</div>
            </div>
            @config.invitationsAndRelationships.zipWithIndex.map { case (invitationOrRelationship, index) =>
            <div id="row-@index" class="table-row">
                <div class="table-cell taxpayerName">
                    <h2 class="sr-only">Row @index</h2>
                    <h3 class="context">@Messages("recent-invitations.table-row-header.clientName")</h3>
                    <span>@invitationOrRelationship.clientName.getOrElse("")</span>
                </div>
                <div class="table-cell serviceInfo">
                    <h3 class="context">@Messages("recent-invitations.table-row-header.service")</h3>
                    <span>
                       @Messages(s"recent-invitations.invitation.service.${invitationOrRelationship.service}")
                    </span>
                </div>
                <div class="table-cell status">
                    <h3 class="context">@Messages("recent-invitations.table-row-header.status")</h3>
                    @Messages(s"recent-invitations.invitation.status.${invitationOrRelationship.status.toLowerCase}")
                    <span class="supplementary-information">@dateInfo(invitationOrRelationship)</span>
                </div>
                <div class="table-cell action @invitationOrRelationship.status.toLowerCase()">
                    <h3 class="context">@Messages("recent-invitations.table-row-header.actions")</h3>
                    @{
                        invitationOrRelationship.status match {
                            case "Pending" => pendingForm(invitationOrRelationship, index)
                            case "Accepted" => if(config.cancelAuthActionFlag) {
                                if(invitationOrRelationship.isRelationshipEnded == false) {
                                  cancelAuthForm(invitationOrRelationship, index)
                                }
                            }
                            case _ => newRequestForm(invitationOrRelationship, index)
                        }
                    }
                </div>
            </div>
            }
        </div>
        @if(config.numberOfPages > 1) {
            @paginationControls
        }
    } else {
        <p>@Messages(s"recent-invitations.empty")</p>
        <p>
            <a href="@routes.AgentInvitationJourneyController.showSelectService()">@Messages(s"recent-invitations.empty.continue")</a>
        </p>
    }
}

@paginationControls = {
    <style type="text/css">
        .pager-items {
            float: right;
            margin: 0;
            display: flex;
        }
        .pager-items li {
            border-right: 1px solid #ddd;
            list-style-type: none;
            border-top: 1px solid #ddd;
            border-bottom: 1px solid #ddd;
            font-size: 0.8em;
        }

        .pager-items li.selected-pagination-item {
            padding: 7px 14px;
        }

        .pager-items li a {
            display: inline-block;
            padding: 7px 14px;
        }

        .pager-items li:first-child {
            border-left: 1px solid #ddd;
        }

        .pager-items li:hover {
          background-color: lightgrey;
          cursor: pointer;
        }

        .pager-items li.selected-pagination-item:hover {
          background-color: transparent;
          cursor: default;
        }

    </style>
    <ul class="pager-items all-sub" style="float: right; display: flex">
        @if(config.pageInfo.page > 1) {
          <li class="prev"><a class="home" href="?page=@(config.pageInfo.page - 1)"><span class="visually-hidden">page</span>Prev </a></li>
        }
        @for(pageNum <- (1 to config.numberOfPages)) {
            @if(pageNum == config.pageInfo.page) {
                <li class="selected-pagination-item">@pageNum</li>
            } else {
                <li><a class="home" href="?page=@pageNum"><span class="visually-hidden">Page</span>@pageNum</a></li>
            }
        }

        @if(config.hasNextPage) {
          <li class="next"><a class="home" href="?page=@(config.pageInfo.page + 1)"><span class="visually-hidden">page</span>Next </a></li>
        }
    </ul>
}

@dateInfo(invitation: TrackInformationSorted)(implicit messages: Messages) = {
@if(invitation.status == "Pending") {
    <span>@Messages("recent-invitations.invitation.expires")</span>
    @displayDate(invitation.expiryDate)
} else {
    @if(invitation.status == "Expired") {
        @displayDate(invitation.expiryDate)
    } else {
        @displayDate(invitation.date)
    }
}
}

@displayDate(date: Option[LocalDate]) = {
@{
    date match {
        case Some(d) => d.toString("dd MMMM yyyy", messages.lang.locale)
        case None => ""
    }
}
}
