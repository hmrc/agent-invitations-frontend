@*
 * Copyright 2023 HM Revenue & Customs
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 *@

@import play.api.Configuration
@import uk.gov.hmrc.agentinvitationsfrontend.config.ExternalUrls
@import uk.gov.hmrc.agentinvitationsfrontend.models.ConfirmedTerms
@import uk.gov.hmrc.agentinvitationsfrontend.util.DisplayDateUtils._
@import uk.gov.hmrc.agentinvitationsfrontend.views.clients.ConfirmTermsPageConfig
@import uk.gov.hmrc.agentinvitationsfrontend.views.html._
@import uk.gov.hmrc.agentinvitationsfrontend.views.html.components.{InputSingleCheckbox, SubmitButton}
@import uk.gov.hmrc.govukfrontend.views.html.components.{ErrorSummary, FormWithCSRF, GovukErrorSummary}
@import uk.gov.hmrc.hmrcfrontend.config.ContactFrontendConfig
@import uk.gov.hmrc.hmrcfrontend.views.html.components.implicits._

@this(
    mainTemplate: MainTemplate,
    errorPrefix: error_prefix,
    govukErrorSummary: GovukErrorSummary,
    formWithCSRF: FormWithCSRF,
    submitButton: SubmitButton,
    inputSingleCheckbox: InputSingleCheckbox,
    p: p, ul: ul, span: span, a: a, ul_html: ul_html,
    li: li, h1: h1, h2: h2
)

@(confirmTermsForm: Form[ConfirmedTerms], pageConfig: ConfirmTermsPageConfig, changingConsent: Boolean = false)(implicit request: Request[_], msgs: Messages, configuration: Configuration, externalUrls: ExternalUrls, contactFrontendConfig: ContactFrontendConfig)

@itsaTerms = {
    @p(
        classes = Some("govuk-!-margin-bottom-4"),
        key = msgs("confirm-terms-multi.itsa.p1", pageConfig.agencyName)
    )
    @ul(items = (1 to 10).map(i => s"confirm-terms-multi.itsa.list.item$i"))
}

@pirTerms = {
    @p(classes = Some("govuk-!-margin-bottom-4"),
        key = msgs("confirm-terms-multi.pir.p1", pageConfig.agencyName)
    )

    @ul_html(
        items =  Seq(span(s"confirm-terms-multi.pir.list.item1"))
                .union(
            Seq(
                Html(
                    msgs("confirm-terms-multi.pir.list.item2") +
                            ul(items = (1 to 4).map(i => s"confirm-terms-multi.pir.list.item2.$i")))
            )
        )
    )
}

@vatTerms = {
    @p(classes = Some("govuk-!-margin-bottom-4"),
        key = msgs("confirm-terms-multi.vat.p1", pageConfig.agencyName)
    )
    @ul_html(
        items = (1 to 6).map(i => span(s"confirm-terms-multi.vat.list.item$i"))
                .union(
                    Seq(
                        Html(
                        msgs("confirm-terms-multi.vat.list.item7") +
                                ul(items = (8 to 11).map(i => s"confirm-terms-multi.vat.list.item$i")))
                    )
            )
    )
}

@trustTerms = {
    @p(classes = Some("govuk-!-margin-bottom-4"),
        key = msgs("confirm-terms-multi.trust.p1", pageConfig.agencyName)
    )
    @ul(items = (1 to 2).map(i => s"confirm-terms-multi.trust.list.item$i"))
}

@trustNTTerms = {
    @p(classes = Some("govuk-!-margin-bottom-4"),
        key = msgs("confirm-terms-multi.trust.p1", pageConfig.agencyName)
    )
    @ul(items = (1 to 2).map(i => s"confirm-terms-multi.trust.list.item$i"))
}

@cgtTerms = {
    @if(pageConfig.clientType == "personal") {
        @p(classes = Some("govuk-!-margin-bottom-4"),
            key = msgs("confirm-terms-multi.cgt.personal.p1", pageConfig.agencyName)
        )
        @ul_html(
            items = (1 to 5).map(i => span(s"confirm-terms-multi.cgt.personal.p1.l$i"))
                    .union(
                Seq(
                    Html(
                        msgs("confirm-terms-multi.cgt.business.p1.l5") +
                                ul(items = (6 to 10).map(i => s"confirm-terms-multi.cgt.personal.p1.l$i")))
                )
            )
        )
    } else {
        @p(classes = Some("govuk-!-margin-bottom-4"),
            key = msgs("confirm-terms-multi.cgt.business.p1", pageConfig.agencyName)
        )
        @ul_html(
            items = (1 to 4).map(i => span(s"confirm-terms-multi.cgt.business.p1.l$i"))
                    .union(
                Seq(
                    Html(
                        msgs("confirm-terms-multi.cgt.business.p1.l5") +
                                ul(items = (6 to 10).map(i => s"confirm-terms-multi.cgt.business.p1.l$i")))
                )
            )
        )

    }
}

@pptTerms = {
  @if(pageConfig.clientType == "personal") {
    @p(classes = Some("govuk-!-margin-bottom-4"),
      key = msgs("confirm-terms-multi.ppt.personal.p1", pageConfig.agencyName)
    )
    @ul(items = (1 to 8).map(i => s"confirm-terms-multi.ppt.personal.p1.l$i"))
  } else {
    @p(classes = Some("govuk-!-margin-bottom-4"),
      key = msgs("confirm-terms-multi.ppt.business.p1", pageConfig.agencyName)
    )
    @ul(items = (1 to 8).map(i => s"confirm-terms-multi.ppt.business.p1.l$i"))
  }
}

@suitableTerms(serviceKey: String, expiryDate: String, isAltItsa: Boolean) = {
    @if(isAltItsa) {
        @p(msgs("confirm-terms-multi.expires.p2", expiryDate))
    }
    @{
        serviceKey match {
            case "itsa" => itsaTerms
            case "afi" => pirTerms
            case "vat" => vatTerms
            case "trust" => trustTerms
            case "trustNT" => trustNTTerms
            case "cgt" => cgtTerms
            case "ppt" => pptTerms
        }
    }
    @if(!isAltItsa) {
        @p(msgs("confirm-terms-multi.expires.p2", expiryDate))
    }
}

@title = @{
   if(changingConsent) msgs("change.consent.heading") else msgs("confirm-terms.multi.heading")
}

@label(serviceKey: String) = @{
    if(pageConfig.clientType == "business" && serviceKey == "cgt") {
        msgs(s"confirm-terms-multi.${serviceKey}.business.label", pageConfig.agencyName)
    } else {
        msgs(s"confirm-terms-multi.${serviceKey}.label", pageConfig.agencyName)
    }
}

@mainTemplate(
    bannerTitle = msgs("service.name.clients"),
    title =  errorPrefix(confirmTermsForm) +  msgs("generic.title", title, msgs("service.name.clients")),
    isAgent = false,
    backLinkHref = Some(pageConfig.backLink.url) ) {

    @if(confirmTermsForm.hasErrors) {
        @govukErrorSummary(ErrorSummary().withFormErrorsAsText(confirmTermsForm))
    }

    @if(request.headers.get("Referer").getOrElse("").endsWith(pageConfig.checkAnswersUrl.url)){
        @h1("confirm-terms.multi-individual.heading", classes = Some("govuk-!-margin-bottom-4"))
    } else {
        @h1("confirm-terms.multi.heading", classes = Some("govuk-!-margin-bottom-4"))
    }

    @p(msgs("confirm-terms.multi.p1", pageConfig.agencyName))

    @p(html = Some(Html(msgs("confirm-terms.subheading2.p1", externalUrls.agentClientManagementUrl))))
    @p(html = Some(Html(msgs("confirm-terms.subheading3.p1", externalUrls.privacypolicyUrl))))

    @formWithCSRF(pageConfig.submitUrl) {

        <fieldset class="govuk-fieldset">
        <legend class="govuk-visually-hidden">
            @msgs(s"confirm-terms.legend.${if(pageConfig.isSingleConsent) "single" else "multi"}",pageConfig.agencyName)
        </legend>

        @for(consent <- pageConfig.serviceKeyAndExpiryDateSeq) {

            @if(pageConfig.isPending(consent)) {

                @if(List("cgt", "ppt").contains(consent.serviceKey)) {
                    @h2(key = s"confirm-terms-multi.${consent.serviceKey}.${pageConfig.clientType}.heading",
                        classes = Some("govuk-!-margin-bottom-4 govuk-!-margin-top-4"))
                }else{
                    @h2(key = s"confirm-terms-multi.${consent.serviceKey}.heading",
                        classes = Some("govuk-!-margin-bottom-4 govuk-!-margin-top-4"))
                }

                @suitableTerms(consent.serviceKey, displayDateForLang(Some(consent.expiryDate)), consent.isAltItsa)

                @if(pageConfig.consentSeq.length == 1 && pageConfig.consentSeq.head.consent) {
                    @inputSingleCheckbox(
                        field = confirmTermsForm(s"confirmedTerms_${consent.serviceKey}"),
                        legend = msgs(s"confirm-terms.legend.${if(pageConfig.isSingleConsent) "single" else "multi"}",pageConfig.agencyName),
                        checkboxText = label(consent.serviceKey),
                        isChecked = true
                    )
                } else {
                    @inputSingleCheckbox(
                        field = confirmTermsForm(s"confirmedTerms.${consent.serviceKey}"),
                        legend = msgs(s"confirm-terms.legend.${if(pageConfig.isSingleConsent) "single" else "multi"}",pageConfig.agencyName),
                        checkboxText = label(consent.serviceKey)
                    )
                }

                @if(pageConfig.consentSeq.length != 1) {
                <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
                }
            }
        }
    </fieldset>
        @submitButton()
    }

}
